# Canvas Editor 実装メモ

最終更新: 2025-08-27

## 要点 (MVP)
- ラベル付きピン: 作成、移動、編集、削除。
- ポリラインツール: クリックで頂点追加、ESCで終了、Backspaceで最後の点を取り消し。
- ピンを起点に角度/長さ指定の直線（現行機能）をツールとして統合。
- ワールド/ビュー変換を使ったマウス/タッチ（ピンチ）のパン/ズーム。
- 選択と変形: クリックで選択、ドラッグで移動、ボックス選択で複数選択。
- スナップ: 端点をピン/頂点にスナップ、任意でグリッドスナップ。
- コマンドスタックによる取り消し/やり直し。
- バージョン付きスキーマのJSONで保存/インポート/エクスポート。
- コンテンツに合わせる（Fit）とズームコントロール。

## TODO
- [ ] Refactor editor/index.js
  - [ ] DOMピンが残るとパフォーマンス低下の恐れ。方針: ピンをキャンバスへ移行。
  - [ ] Pointer Events API
- [ ] `src/editor/` の足場作成（モジュール分割）
- [ ] `state.js`（選択状態を含む）
- [ ] `renderer.js`（`setTransform` とダーティフラグ）
- [ ] `input.js`（Pointer/Keyboard正規化）
- [ ] `selectTool.js`（ヒットテスト/移動/ボックス選択）
- [ ] `polylineTool.js`（完了/キャンセル/Shift制約）
- [ ] `lineFromAngleTool.js`（角度/長さUIの統合）
- [ ] スナップ（ピン/頂点/グリッド）
- [ ] コマンドスタック（Undo/Redoの合体含む）
- [ ] JSON入出力（v1スキーマ/検証/移行）
- [ ] Fit-to-content とズームUI
- [ ] ヒットテストの拡張（必要に応じ四分木）
- [ ] パフォーマンス最適化（バッチ描画/キャッシュ）
- [ ] アクセシビリティの基本（ショートカット/ハンドル）
- [ ] ユニットテスト（`geom`/`commands`/`io`）

MVPの非目標
- 曲線（ベジェ）、リッチなテキスト装飾、レイヤーUI、画像、印刷、コラボレーション。

---

## 現在の状態（リポジトリ時点）
- コンポーネント: `src/DriftmapEditor.js` の `driftmap-editor`。2枚のキャンバス（`lineCanvas`、`interactionCanvas`）と、メモ付きDOMピン（絶対配置）。
- 機能: ピン追加（メモをプロンプト）、フリーハンド線描画と角度/長さ指定線、ピンチズーム（scale）、簡易Fit-to-all、基本的な変換（`scale`、`offsetX/Y`）。
- 未解決: 選択/ドラッグなし、ピンがキャンバス外のDOM、Undo/Redoなし、状態と描画が密結合、シリアライズ未実装、ヒットテストが最小限。

## 目標
- 状態、ツール、レンダリング、I/Oを明確に分離したエディタのアーキテクチャを確立する。
- デスクトップとモバイルの双方を、統一されたポインターイベントでサポートする。
- 数百〜数千の頂点でも滑らかなパフォーマンスを維持する。

## アーキテクチャ
- Web Component: ホストとしての `driftmap-editor` を維持。内部モジュールは `src/editor/` 配下。
- Modules:
  - `state.js`: 正規のワールド状態（pins, polylines, selection）。更新イベントを発行。
  - `renderer.js`: 現在のビュー変換を用いて単一キャンバス（または2レイヤー）へ描画。
  - `tools/`:
    - `selectTool.js`: ヒットテスト、選択、移動/ドラッグ、ボックス選択。
    - `polylineTool.js`: クリックで頂点追加、閉じる/完了、キャンセル。
    - `lineFromAngleTool.js`: アンカーピンからの角度/長さ（既存ロジックをリファクタ）。
  - `input.js`: ポインタ/マウス/タッチ/キーボードをツール操作へ正規化。
  - `commands.js`: コマンドパターンでのUndo/Redo（do/undo、移動の合体）。
  - `io.js`: JSONのインポート/エクスポート、バージョン付きスキーマ、移行ヘルパー。
  - `geom.js`: 共有数学（画面↔ワールド、セグメントヒットテスト、距離、スナップ）。
- イベントフロー: 入力 → アクティブツール → コマンド（`state` を変更）→ レンダラが購読して再描画。
- ビュー変換: `view = { scale, translateX, translateY }` を保持。ワールド座標に値を焼き込まない。

### フレームワーク選定（レビュー回答）
- 方針: コア編集エンジン（状態/描画/ツール/IO）はフレームワーク非依存のモジュールとして実装し、ホストは既存どおり Web Component を用いる。
- UIシェル（ツールバーやポップオーバー等）が複雑化する場合のみ軽量なフレームワークを検討。
  - 候補1: Preact（軽量、JSXでUI実装しやすい）。
  - 候補2: Lit（Web Components との親和性が高い）。
- MVP判断: 当面は素のWeb Components + モジュールで進め、MVP達成後にUI複雑度を見て導入可否を再評価。
- 理由: キャンバス描画中心のためフレームワークのメリットが小さく、依存削減とパフォーマンス予測性を優先。

## データモデル（ワールド座標）
- `Pin { id, x, y, memo }`
- `Polyline { id, points: [{x,y}], stroke, metadata }`
- `Selection { pins: Set<id>, polylines: Set<id> }`
- グローバル: `{ pins: Map<id,Pin>, polylines: Map<id,Polyline>, selection, nextId, version }`
- ID: 単調増加の整数またはUUID。高速性のため小さな整数を優先。

## 描画
- フレーム毎に `ctx.setTransform(scale,0,0,scale,tx,ty)` を設定し、ピンとポリラインを描く単一キャンバス。
- 描画順: グリッド（任意）→ ポリライン → ピン → 選択ハンドル/オーバーレイ。
- 冗長な再描画を避けるため `requestAnimationFrame` とダーティフラグを使用。
- ヒットテスト: まずは線形走査から。スケールが必要になれば四分木へ。

## ツールとインタラクション
- ツール切替: ツールバーまたはホットキー（V=select, P=polyline, L=line-by-angle）。
- 選択
  - 空白をクリック: 選択解除。ドラッグでボックス選択。
  - ピン/セグメント/頂点をクリック: 選択。ドラッグで移動。Shiftで追加/除外。
  - Deleteキー: 選択削除（項目数>Nなら確認）。
- ポリライン
  - クリックで頂点追加。Enter/ダブルクリックで完了。ESCでキャンセル。
  - Shiftで45°刻みの制約。
- 角度線
  - 選択したピンからのUIポップオーバー。角度/長さ入力。プレビューのゴーストライン。
- パン/ズーム
  - マウスホイールでカーソル位置にズーム。スペースバーまたは中ボタンでドラッグしてパン。
  - タッチ: 2本指でピンチ/ドラッグ。

## スナップ
- 種類: ピン、既存ポリラインの頂点、グリッド。
- 視覚フィードバック: 小さな照準/ツールチップ。描画中は一時的に角度/長さを表示。

## 取り消し/やり直し
- コマンドスタック（例: ドラッグ移動をまとめて合体）。
- キーボード: Ctrl/Cmd+Z、Shift+Ctrl/Cmd+Z。

## 永続化
- JSONスキーマ（v1）:
  ```json
  {
    "version": 1,
    "pins": [{"id": 1, "x": 100, "y": 120, "memo": "A"}],
    "polylines": [{"id": 1, "points": [{"x":100,"y":120},{"x":180,"y":150}], "stroke": {"color": "#1976d2", "width": 2}}]
  }
  ```
- インポート: 検証し、古いバージョンを検出したら移行。
- エクスポート: ダウンロード可能なファイルとクリップボードコピー。

## パフォーマンス
- バッチ描画。頂点ごとのDOMを避ける。
- scale/translateが安定している間はワールド→スクリーン変換点を任意でキャッシュ。

## アクセシビリティとUX
- キーボードショートカット。フォーカス可能なツールバー。ハイコントラストのハンドル。
- 小さすぎるヒットターゲットを避ける。最小24pxのタッチターゲット。

## テスト
- `geom.js`、`commands.js`、`io.js` のユニットテスト（テスト基盤がある場合）。
- 手動シナリオ: 大規模ポリライン、急速なパン/ズーム、長時間セッションでのメモリ使用量。

## ロードマップ
- 0.1 MVP（1週目）
  - 状態モジュール、レンダラ、選択+移動、インポート/エクスポート。
- 0.2 描画（2週目）
  - ポリラインツール、スナップ、Undo/Redo。
- 0.3 角度線（3週目）
  - 既存の角度/長さツールをツールチェーンへリファクタ。UI磨き。
- 0.4 仕上げ（4週目）
  - ボックス選択、ズームコントロール、コンテンツに合わせる、基本ツールバー。

## 未決事項
- ピンは独立したエンティティのままか、長さ0のポリラインとして統一するか？
- レイヤーは今必要か、それとも後回しにできるか？
- メモはピンのみに限定するか、セグメント/頂点にも付与可能にするか？

## 次のアクション
- 上記MVPスコープの承認。
- `src/editor/` の足場を作成し、現行ロジックを段階的に移行。
- まずは state + renderer + select ツールを実装し、移行中も機能同等を維持。
